<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥ä½œæ¥­å“¡å·¥æ™‚æ˜ç´°è¡¨ç”¢ç”Ÿå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background: #e9ecef;
            border-color: #2980b9;
        }
        .upload-area.dragover {
            background: #d4edda;
            border-color: #28a745;
        }
        input[type="file"] {
            display: none;
        }
        .upload-btn, .process-btn, .download-btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        .upload-btn:hover, .process-btn:hover, .download-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .process-btn {
            background: #27ae60;
            width: 100%;
            font-size: 18px;
            font-weight: bold;
            padding: 15px 30px;
        }
        .process-btn:hover {
            background: #229954;
        }
        .process-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        .download-btn {
            background: #e74c3c;
        }
        .download-btn:hover {
            background: #c0392b;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
        .sample-data {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f1f2f6;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .warning-icon {
            color: #e74c3c;
            font-weight: bold;
            margin-right: 5px;
            font-size: 1.2em;
        }
        .abnormal-row {
            background-color: #fff5f5;
        }
        .hours-cell {
            font-weight: bold;
        }
        .abnormal-hours {
            color: #e74c3c;
        }
        .normal-hours {
            color: #27ae60;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        .csv-output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æ¯æ—¥ä½œæ¥­å“¡å·¥æ™‚æ˜ç´°è¡¨ç”¢ç”Ÿå™¨</h1>
        
        <div class="upload-area" id="uploadArea">
            <h3>ğŸ“ è«‹é¸æ“‡æˆ–æ‹–æ‹½ MES å·¥å–®äººå“¡è¨˜éŒ„è¡¨æª”æ¡ˆ</h3>
            <p>æ”¯æ´æ ¼å¼: Excel (.xlsx, .xls)</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                é¸æ“‡æª”æ¡ˆ
            </button>
            <div id="fileName" style="margin-top: 15px; font-weight: bold; color: #2c3e50;"></div>
        </div>

        <button class="process-btn" id="processBtn" onclick="processFile()" disabled>
            ğŸ”„ é–‹å§‹è™•ç†ä¸¦ç”¢ç”Ÿå ±è¡¨
        </button>

        <div id="filterArea" class="results" style="display: none;">
            <h3>ğŸ” ç¯©é¸æ¢ä»¶</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="dateSelect">é¸æ“‡æ—¥æœŸï¼š</label>
                    <select id="dateSelect">
                        <option value="">å…¨éƒ¨æ—¥æœŸ</option>
                    </select>
                </div>
                <div>
                    <label for="factorySelect">é¸æ“‡å» åˆ¥ï¼š</label>
                    <select id="factorySelect">
                        <option value="">å…¨éƒ¨å» åˆ¥</option>
                    </select>
                </div>
            </div>
            <button class="process-btn" onclick="applyFilters()" style="background: #f39c12;">
                ğŸ“‹ å¥—ç”¨ç¯©é¸ä¸¦é¡¯ç¤ºçµæœ
            </button>
        </div>

        <div id="results" class="results" style="display: none;">
            <h3>ğŸ“ˆ ç¯©é¸çµæœ</h3>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        let allProcessedData = null;
        let processedData = null;

        // æª”æ¡ˆæ‹–æ‹½è™•ç†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('dragover');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        fileInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                document.getElementById('fileName').textContent = `å·²é¸æ“‡: ${file.name}`;
                document.getElementById('processBtn').disabled = false;
                window.selectedFile = file;
            }
        }

        async function processFile() {
            if (!window.selectedFile) {
                alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
                return;
            }

            const filterArea = document.getElementById('filterArea');
            filterArea.style.display = 'block';
            
            filterArea.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è™•ç†è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
                </div>
            `;

            try {
                const arrayBuffer = await window.selectedFile.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const originalWorkbook = XLSX.read(data, { type: 'array' });
                
                const firstSheetName = originalWorkbook.SheetNames[0];
                const worksheet = originalWorkbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                const headers = jsonData[0];
                const records = jsonData.slice(1).filter(row => row[3] && row[8] && row[9]);
                
                const dailyStats = {};

                records.forEach(row => {
                    const employeeName = row[3];
                    const workOrderNo = row[5];
                    const startTime = row[8];
                    const endTime = row[9];
                    
                    let factory = 'å…¶ä»–';
                    if (workOrderNo) {
                        const prefix = workOrderNo.toString().substring(0, 4);
                        switch(prefix) {
                            case 'GE11': factory = 'å®—ç‘‹å» _æˆå‹'; break;
                            case 'DE11': factory = 'åšå£«å» _æˆå‹'; break;
                            case 'GE31': factory = 'å®—ç‘‹å» _çµ„è£'; break;
                            case 'DE31': factory = 'åšå£«å» _çµ„è£'; break;
                        }
                    }
                    
                    const workDate = new Date(startTime).toLocaleDateString('zh-TW');
                    const key = `${employeeName}_${workDate}_${factory}`;
                    
                    if (!dailyStats[key]) {
                        dailyStats[key] = {
                            å“¡å·¥å§“å: employeeName,
                            å» åˆ¥: factory,
                            å·¥ä½œæ—¥æœŸ: workDate,
                            é–‹å§‹æ™‚é–“: startTime,
                            çµæŸæ™‚é–“: endTime
                        };
                    } else {
                        if (new Date(startTime) < new Date(dailyStats[key].é–‹å§‹æ™‚é–“)) {
                            dailyStats[key].é–‹å§‹æ™‚é–“ = startTime;
                        }
                        if (new Date(endTime) > new Date(dailyStats[key].çµæŸæ™‚é–“)) {
                            dailyStats[key].çµæŸæ™‚é–“ = endTime;
                        }
                    }
                });

                const results = [];
                Object.values(dailyStats).forEach(stat => {
                    const start = new Date(stat.é–‹å§‹æ™‚é–“);
                    const end = new Date(stat.çµæŸæ™‚é–“);
                    const hoursDiff = (end - start) / (1000 * 60 * 60);
                    
                    const startTimeStr = start.toLocaleTimeString('zh-TW', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: false 
                    });
                    const endTimeStr = end.toLocaleTimeString('zh-TW', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: false 
                    });
                    
                    const hours = Math.floor(hoursDiff);
                    const minutes = Math.round((hoursDiff % 1) * 60);
                    const durationStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    
                    const isAbnormal = hoursDiff < 8 || hoursDiff > 13;
                    
                    results.push({
                        æ—¥æœŸ: stat.å·¥ä½œæ—¥æœŸ,
                        å» åˆ¥: stat.å» åˆ¥,
                        å“¡å·¥å§“å: stat.å“¡å·¥å§“å,
                        é–‹å§‹æ™‚é–“: startTimeStr,
                        çµæŸæ™‚é–“: endTimeStr,
                        å·¥ä½œæ™‚æ•¸: durationStr,
                        å·¥æ™‚æ•¸å€¼: hoursDiff,
                        ç•°å¸¸ç‹€æ³: isAbnormal
                    });
                });

                allProcessedData = results;
                setupFilters(results);
                
            } catch (error) {
                filterArea.innerHTML = `<div class="error">âŒ è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
                console.error('è™•ç†éŒ¯èª¤:', error);
            }
        }

        function setupFilters(data) {
            const uniqueDates = [...new Set(data.map(item => item.æ—¥æœŸ))].sort();
            const uniqueFactories = [...new Set(data.map(item => item.å» åˆ¥))].sort();
            
            const filterArea = document.getElementById('filterArea');
            filterArea.innerHTML = `
                <h3>ğŸ” ç¯©é¸æ¢ä»¶</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label for="dateSelect">é¸æ“‡æ—¥æœŸï¼š</label>
                        <select id="dateSelect">
                            <option value="">å…¨éƒ¨æ—¥æœŸ</option>
                            ${uniqueDates.map(date => `<option value="${date}">${date}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="factorySelect">é¸æ“‡å» åˆ¥ï¼š</label>
                        <select id="factorySelect">
                            <option value="">å…¨éƒ¨å» åˆ¥</option>
                            ${uniqueFactories.map(factory => `<option value="${factory}">${factory}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <button class="process-btn" onclick="applyFilters()" style="background: #f39c12;">
                    ğŸ“‹ å¥—ç”¨ç¯©é¸ä¸¦é¡¯ç¤ºçµæœ
                </button>
            `;
        }

        function applyFilters() {
            if (!allProcessedData) {
                alert('è«‹å…ˆè™•ç†æª”æ¡ˆ');
                return;
            }

            const selectedDate = document.getElementById('dateSelect').value;
            const selectedFactory = document.getElementById('factorySelect').value;
            
            let filteredData = allProcessedData;
            
            if (selectedDate) {
                filteredData = filteredData.filter(item => item.æ—¥æœŸ === selectedDate);
            }
            
            if (selectedFactory) {
                filteredData = filteredData.filter(item => item.å» åˆ¥ === selectedFactory);
            }
            
            filteredData.sort((a, b) => {
                if (a.ç•°å¸¸ç‹€æ³ !== b.ç•°å¸¸ç‹€æ³) {
                    return b.ç•°å¸¸ç‹€æ³ ? 1 : -1;
                }
                if (a.æ—¥æœŸ !== b.æ—¥æœŸ) return a.æ—¥æœŸ.localeCompare(b.æ—¥æœŸ);
                if (a.å» åˆ¥ !== b.å» åˆ¥) return a.å» åˆ¥.localeCompare(b.å» åˆ¥);
                return a.å·¥æ™‚æ•¸å€¼ - b.å·¥æ™‚æ•¸å€¼;
            });
            
            displayFilteredResults(filteredData, selectedDate, selectedFactory);
        }

        function displayFilteredResults(filteredData, selectedDate, selectedFactory) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            resultsDiv.style.display = 'block';
            
            const totalRecords = filteredData.length;
            const uniqueEmployees = [...new Set(filteredData.map(item => item.å“¡å·¥å§“å))].length;
            const factories = [...new Set(filteredData.map(item => item.å» åˆ¥))];
            const abnormalRecords = filteredData.filter(item => item.ç•°å¸¸ç‹€æ³).length;
            
            let filterInfo = '';
            if (selectedDate || selectedFactory) {
                filterInfo = `
                    <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                        <strong>ğŸ“‹ ç›®å‰ç¯©é¸æ¢ä»¶ï¼š</strong>
                        ${selectedDate ? `æ—¥æœŸ: ${selectedDate}` : ''}
                        ${selectedDate && selectedFactory ? ' | ' : ''}
                        ${selectedFactory ? `å» åˆ¥: ${selectedFactory}` : ''}
                        ${!selectedDate && !selectedFactory ? 'é¡¯ç¤ºå…¨éƒ¨è³‡æ–™' : ''}
                    </div>
                `;
            }
            
            let abnormalWarning = '';
            if (abnormalRecords > 0) {
                abnormalWarning = `
                    <div style="background: #fff5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #e74c3c;">
                        <strong>âš ï¸ ç•°å¸¸å·¥æ™‚æé†’ï¼š</strong>
                        ç™¼ç¾ ${abnormalRecords} ç­†ç•°å¸¸å·¥æ™‚è¨˜éŒ„ï¼ˆå·¥æ™‚<8å°æ™‚ æˆ– >13å°æ™‚ï¼‰ï¼Œå·²æ¨™ç¤ºç´…è‰²è­¦ç¤ºä¸¦å„ªå…ˆé¡¯ç¤º
                    </div>
                `;
            }
            
            const statsHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${totalRecords}</div>
                        <div class="stat-label">ç¯©é¸å¾Œè¨˜éŒ„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${uniqueEmployees}</div>
                        <div class="stat-label">å“¡å·¥äººæ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${factories.length}</div>
                        <div class="stat-label">æ¶‰åŠå» åˆ¥æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: ${abnormalRecords > 0 ? '#e74c3c' : '#27ae60'}">${abnormalRecords}</div>
                        <div class="stat-label">ç•°å¸¸å·¥æ™‚è¨˜éŒ„</div>
                    </div>
                </div>
            `;
            
            let tableHTML = `
                <div class="sample-data">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4>ğŸ“Š å·¥æ™‚æ˜ç´°è¡¨</h4>
                        <span style="color: #7f8c8d;">å…± ${totalRecords} ç­†è¨˜éŒ„ ${abnormalRecords > 0 ? `(${abnormalRecords} ç­†ç•°å¸¸)` : ''}</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;">ç‹€æ…‹</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>å» åˆ¥</th>
                                    <th>å“¡å·¥å§“å</th>
                                    <th>é–‹å§‹æ™‚é–“</th>
                                    <th>çµæŸæ™‚é–“</th>
                                    <th>å·¥ä½œæ™‚æ•¸</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            filteredData.forEach(item => {
                const rowClass = item.ç•°å¸¸ç‹€æ³ ? 'abnormal-row' : '';
                const hoursClass = item.ç•°å¸¸ç‹€æ³ ? 'abnormal-hours' : 'normal-hours';
                const statusIcon = item.ç•°å¸¸ç‹€æ³ ? '<span class="warning-icon">âš ï¸</span>' : '';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td style="text-align: center; width: 50px;">${statusIcon}</td>
                        <td>${item.æ—¥æœŸ}</td>
                        <td>${item.å» åˆ¥}</td>
                        <td>${item.å“¡å·¥å§“å}</td>
                        <td>${item.é–‹å§‹æ™‚é–“}</td>
                        <td>${item.çµæŸæ™‚é–“}</td>
                        <td class="hours-cell ${hoursClass}">${statusIcon}${item.å·¥ä½œæ™‚æ•¸}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">
                        <strong>ğŸ“‹ èªªæ˜ï¼š</strong>
                        <span style="color: #e74c3c;">âš ï¸ ç•°å¸¸å·¥æ™‚</span>ï¼ˆ<8å°æ™‚ æˆ– >13å°æ™‚ï¼‰æœƒåœ¨å·¥ä½œæ™‚æ•¸å‰é¡¯ç¤ºè­¦ç¤ºåœ–ç¤º |
                        æ’åºï¼šç•°å¸¸å„ªå…ˆ â†’ æ—¥æœŸ â†’ å» åˆ¥ â†’ å·¥æ™‚å°‘åˆ°å¤š
                    </div>
                </div>
            `;

            // ç”¢ç”ŸCSVæ ¼å¼çš„è³‡æ–™é¡¯ç¤º
            let csvData = 'ç‹€æ…‹,æ—¥æœŸ,å» åˆ¥,å“¡å·¥å§“å,é–‹å§‹æ™‚é–“,çµæŸæ™‚é–“,å·¥ä½œæ™‚æ•¸,ç•°å¸¸èªªæ˜\n';
            filteredData.forEach(item => {
                const status = item.ç•°å¸¸ç‹€æ³ ? 'ç•°å¸¸' : 'æ­£å¸¸';
                let abnormalNote = '';
                if (item.ç•°å¸¸ç‹€æ³) {
                    if (item.å·¥æ™‚æ•¸å€¼ < 8) {
                        abnormalNote = 'å·¥æ™‚ä¸è¶³8å°æ™‚';
                    } else if (item.å·¥æ™‚æ•¸å€¼ > 13) {
                        abnormalNote = 'å·¥æ™‚è¶…é13å°æ™‚';
                    }
                }
                
                csvData += `${status},${item.æ—¥æœŸ},${item.å» åˆ¥},${item.å“¡å·¥å§“å},${item.é–‹å§‹æ™‚é–“},${item.çµæŸæ™‚é–“},${item.å·¥ä½œæ™‚æ•¸},${abnormalNote}\n`;
            });
            
            resultsContent.innerHTML = `
                ${filterInfo}
                ${abnormalWarning}
                ${statsHTML}
                ${tableHTML}
                <div style="text-align: center; margin-top: 20px;">
                    <button class="download-btn" onclick="downloadCSV()">
                        ğŸ“¥ ä¸‹è¼‰ CSV æª”æ¡ˆ
                    </button>
                    <button class="download-btn" onclick="copyToClipboard()" style="background: #9b59b6;">
                        ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿
                    </button>
                </div>
                <div class="sample-data">
                    <h4>ğŸ“„ CSV è³‡æ–™é è¦½ (å¯ç›´æ¥è¤‡è£½è²¼åˆ°Excel)</h4>
                    <div class="csv-output" id="csvOutput">${csvData}</div>
                </div>
            `;
            
            processedData = filteredData;
            window.csvData = csvData;
        }

        function downloadCSV() {
            if (!window.csvData) {
                alert('æ²’æœ‰è³‡æ–™å¯ä¸‹è¼‰');
                return;
            }
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW').replace(/\//g, '');
            const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false }).replace(/:/g, '');
            const filename = `æ¯æ—¥ä½œæ¥­å“¡å·¥æ™‚æ˜ç´°è¡¨_${dateStr}_${timeStr}.csv`;
            
            // åŠ å…¥BOMä»¥æ”¯æ´ä¸­æ–‡
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + window.csvData], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccessMessage(`âœ… CSVæª”æ¡ˆå·²ä¸‹è¼‰: ${filename}`);
            }
        }
        
        function copyToClipboard() {
            if (!window.csvData) {
                alert('æ²’æœ‰è³‡æ–™å¯è¤‡è£½');
                return;
            }
            
            navigator.clipboard.writeText(window.csvData).then(function() {
                showSuccessMessage('âœ… è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œå¯ç›´æ¥è²¼åˆ°Excelä¸­');
            }, function(err) {
                // å‚™ç”¨æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = window.csvData;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccessMessage('âœ… è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œå¯ç›´æ¥è²¼åˆ°Excelä¸­');
            });
        }
        
        function showSuccessMessage(message) {
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.innerHTML = message;
            document.getElementById('resultsContent').insertBefore(successMsg, document.getElementById('resultsContent').firstChild);
            setTimeout(() => successMsg.remove(), 5000);
        }
    </script>
</body>
</html>